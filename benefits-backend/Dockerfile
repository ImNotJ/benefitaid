# Stage 1: Build the application
FROM maven:3.8.4-openjdk-17 AS build
WORKDIR /app
# Accept build arguments and set environment variables
ARG ROOT_ADMIN_USERNAME
ARG ROOT_ADMIN_PASSWORD
ARG JWT_SECRET_KEY
ARG DB_USERNAME
ARG DB_PASSWORD

ENV ROOT_ADMIN_USERNAME=${ROOT_ADMIN_USERNAME}
ENV ROOT_ADMIN_PASSWORD=${ROOT_ADMIN_PASSWORD}
ENV JWT_SECRET_KEY=${JWT_SECRET_KEY}
ENV DB_USERNAME=${DB_USERNAME}
ENV DB_PASSWORD=${DB_PASSWORD}


COPY . .
RUN mvn clean package

# Stage 2: Run the application
FROM openjdk:17-jdk-slim
WORKDIR /app
# Accept build arguments and set environment variables
ARG ROOT_ADMIN_USERNAME
ARG ROOT_ADMIN_PASSWORD
ARG JWT_SECRET_KEY
ARG DB_USERNAME
ARG DB_PASSWORD

ENV ROOT_ADMIN_USERNAME=${ROOT_ADMIN_USERNAME}
ENV ROOT_ADMIN_PASSWORD=${ROOT_ADMIN_PASSWORD}
ENV JWT_SECRET_KEY=${JWT_SECRET_KEY}
ENV DB_USERNAME=${DB_USERNAME}
ENV DB_PASSWORD=${DB_PASSWORD}


COPY --from=build /app/target/benefits-backend-0.0.1-SNAPSHOT.jar /app/benefits-backend.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "benefits-backend.jar"]